<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UI Detection Test</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
    .test-section { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .result { margin-top: 8px; padding: 8px; background: #f9fafb; border-radius: 4px; }
    button { padding: 8px 16px; margin: 4px; border: 1px solid #d1d5db; border-radius: 4px; background: white; cursor: pointer; }
    button:hover { background: #f3f4f6; }
  </style>
</head>
<body>
  <h1>UI Detection Test</h1>

  <div class="test-section">
    <h3>Test 1: Valid UI Response</h3>
    <button onclick="testValidUI()">Test Valid UI Response</button>
    <div id="test1-result" class="result">Click to test...</div>
  </div>

  <div class="test-section">
    <h3>Test 2: Invalid UI URI</h3>
    <button onclick="testInvalidUI()">Test Invalid UI URI</button>
    <div id="test2-result" class="result">Click to test...</div>
  </div>

  <div class="test-section">
    <h3>Test 3: No UI Field</h3>
    <button onclick="testNoUI()">Test No UI Field</button>
    <div id="test3-result" class="result">Click to test...</div>
  </div>

  <div class="test-section">
    <h3>Test 4: Widget Rendering</h3>
    <button onclick="testWidgetRender()">Test Widget Rendering</button>
    <div id="test4-result" class="result">Click to test...</div>
  </div>

  <div class="test-section">
    <h3>Test 5: MCP Integration Test</h3>
    <button onclick="testMCPIntegration()">Test MCP find_care_v1</button>
    <div id="test5-result" class="result">Click to test...</div>
  </div>

  <script>
    // Simulate the component logic
    const ALLOWED_UI_URIS = new Set([
      "ui://find-care/widget.html",
      "ui://find-care/confirmation.html"
    ]);

    function detectAndRender(props) {
      if (props.ui && props.ui.startsWith("ui://")) {
        if (!ALLOWED_UI_URIS.has(props.ui)) {
          return `‚ùå Fallback: Unrecognized UI URI: ${props.ui}\n\n${props.fallback_markdown || 'No fallback'}`;
        }

        const widgetData = props.uiProps && props.uiProps.query && props.uiProps.results
          ? props.uiProps
          : { results: props.results || [], query: props.query || {} };

        return `‚úÖ Widget Rendered: ${props.ui}\nData: ${JSON.stringify(widgetData, null, 2)}\nFallback available: ${!!props.fallback_markdown}`;
      }

      return `üìù Traditional Render: ${props.results ? props.results.length + ' facilities' : 'No results'}`;
    }

    window.testValidUI = function() {
      console.log('testValidUI called');
      const props = {
        ui: "ui://find-care/widget.html",
        uiProps: {
          query: { zip: "98201", venue: "urgent_care" },
          results: [
            { id: "test1", name: "Test Facility 1", distance: 5.2, openNow: true },
            { id: "test2", name: "Test Facility 2", distance: 8.1, openNow: false }
          ]
        },
        fallback_markdown: "### Test Facilities\n- Test Facility 1 (5.2 mi) ‚Äî Open\n- Test Facility 2 (8.1 mi) ‚Äî Closed"
      };
      const result = detectAndRender(props);
      console.log('testValidUI result:', result);
      const element = document.getElementById('test1-result');
      if (element) {
        element.textContent = result;
        element.style.backgroundColor = '#e0f0e0'; // Make it visible that it changed
        console.log('Updated element:', element.textContent);
      } else {
        console.error('Element test1-result not found');
      }
    };

    window.testInvalidUI = function() {
      console.log('testInvalidUI called');
      const props = {
        ui: "ui://evil/widget.html",
        uiProps: { results: [] },
        fallback_markdown: "Fallback content"
      };
      const result = detectAndRender(props);
      console.log('testInvalidUI result:', result);
      const element = document.getElementById('test2-result');
      if (element) {
        element.textContent = result;
        element.style.backgroundColor = '#ffe0e0';
      }
    };

    window.testNoUI = function() {
      console.log('testNoUI called');
      const props = {
        results: [
          { id: "test1", name: "Test Facility 1", distance: 5.2, openNow: true }
        ],
        query: "98201",
        venue: "urgent_care"
      };
      const result = detectAndRender(props);
      console.log('testNoUI result:', result);
      const element = document.getElementById('test3-result');
      if (element) {
        element.textContent = result;
        element.style.backgroundColor = '#e0e0ff';
      }
    };

    function testWidgetRender() {
      const iframeSrc = `/public/find-care-test.html?props=${encodeURIComponent(JSON.stringify({
        query: { zip: "98201", venue: "urgent_care" },
        results: [
          { id: "test1", name: "Test Facility 1", distance: 5.2, openNow: true, address: { line1: "123 Main St", city: "Test City", state: "WA", zip: "98201" } }
        ]
      }))}`;

      document.getElementById('test4-result').innerHTML = `
        <p>Widget would render iframe:</p>
        <code style="font-size:12px; word-break: break-all;">${iframeSrc}</code>
        <br><br>
        <iframe src="${iframeSrc}" style="width:100%; height:200px; border:1px solid #ccc;" title="Test Widget"></iframe>
      `;
    }
  }

  window.testMCPIntegration = async function() {
    console.log('testMCPIntegration called');
    const resultEl = document.getElementById('test5-result');
    resultEl.textContent = 'Testing MCP endpoint...';
    resultEl.style.backgroundColor = '#fff3cd';

    try {
      const response = await fetch('/mcp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          jsonrpc: '2.0',
          id: 1,
          method: 'tools/call',
          params: {
            name: 'find_care_v1',
            arguments: { zip: '98201', venue: 'urgent_care' }
          }
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const data = await response.json();
      console.log('MCP response data:', data);

      if (data.result && data.result.content && data.result.content[0]) {
        const content = data.result.content[0];
        if (content.type === 'text') {
          const uiData = JSON.parse(content.text);

          resultEl.innerHTML = `
            <div style="color: green;">‚úÖ MCP Response Valid</div>
            <div><strong>UI:</strong> ${uiData.ui}</div>
            <div><strong>Results:</strong> ${uiData.props?.results?.length || 0} facilities</div>
            <div><strong>Query:</strong> ${JSON.stringify(uiData.props?.query)}</div>
            <div><strong>Has Fallback:</strong> ${!!uiData.fallback_markdown}</div>
          `;
          resultEl.style.backgroundColor = '#d4edda';
        } else {
          resultEl.innerHTML = `<div style="color: red;">‚ùå Unexpected content type: ${content.type}</div>`;
          resultEl.style.backgroundColor = '#f8d7da';
        }
      } else {
        resultEl.innerHTML = `<div style="color: red;">‚ùå Invalid response structure</div>`;
        resultEl.style.backgroundColor = '#f8d7da';
      }
    } catch (error) {
      console.error('MCP test error:', error);
      resultEl.innerHTML = `<div style="color: red;">‚ùå Error: ${error.message}</div>`;
      resultEl.style.backgroundColor = '#f8d7da';
    }
  </script>
</body>
</html>
